<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Plog</title>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }

        .navbar {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            background-color: #f5f5f5;
            align-items: center;
        }

        .left, .right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        a {
            text-decoration: none;
            color: #333;
            padding: 6px 12px;
            border-radius: 4px;
        }

        a:hover { background-color: #ddd; }

        .navbar-title {
            font-size: 32px;
            font-weight: bold;
            color: green;
            font-family: 'Courier New', Courier, monospace;
            letter-spacing: 2px;
        }

        .search-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .search-container input {
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid #ccc;
            width: 200px;
        }

        .search-container button {
            padding: 6px 12px;
            border-radius: 4px;
            background-color: #4CAF50;
            color: white;
            border: none;
        }

        .search-container button:hover { background-color: #45a049; }

        .main-container {
            display: flex;
            justify-content: center;
            padding: 0 20px 40px;
            gap: 20px;
        }

        #map {
            width: 600px;
            height: 600px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .blog-list {
            width: 600px;
            height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .blog-card {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 20px;
            background-color: #fafafa;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .blog-title {
            font-size: 22px;
            color: #2a5d9f;
            margin-bottom: 14px;
            display: block;
        }

        .blog-location {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
            cursor: pointer;
        }

        .blog-content-preview {
            font-size: 15px;
            color: #333;
            margin-bottom: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>

<div class="navbar">
    <div class="left">
        <a th:href="@{/}" class="navbar-title">Plog</a>
    </div>

    <div class="right">
        <div th:if="${name == 'anonymousUser'}">
            <a th:href="@{/login}">로그인</a>
            <a th:href="@{/signup}">회원가입</a>
        </div>
        <div th:if="${name != 'anonymousUser'}">
            <a th:href="@{/my-planner}">내 플래너</a>
            <a th:href="@{'/user/my_blog/' + ${name}}">내 블로그</a>
            <a th:href="@{'/user/update/' + ${name}}" th:text="${nickname} + '님'"></a>
            <a th:href="@{/logout}">로그아웃</a>
        </div>
    </div>
</div>

<div class="main-container">
    <div id="map"></div>

    <div class="blog-list"></div>
</div>

<script
        type="text/javascript"
        th:src="@{'https://dapi.kakao.com/v2/maps/sdk.js?appkey=' + ${kakaoApiKey} + '&autoload=false'}">
</script>

<script>
    let map = null;
    let marker = null;

    kakao.maps.load(() => {
        map = new kakao.maps.Map(document.getElementById('map'), {
            center: new kakao.maps.LatLng(35.142785, 126.934717),
            level: 3
        });

        kakao.maps.event.addListener(map, 'click', event => {
            const lat = event.latLng.getLat();
            const lng = event.latLng.getLng();

            if (marker) marker.setMap(null);

            marker = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(lat, lng),
                map: map
            });

            kakao.maps.event.addListener(marker, 'click', () => {
                marker.setMap(null);
                marker = null;
                loadAllBlogs();
            });

            fetch(`/nearby?lat=${lat}&lng=${lng}&radius=1.0`)
                .then(res => res.json())
                .then(data => {
                    // 묶지 않고 각 위치별로 따로 표시
                    renderNearbyBlogsSeparately(data);
                });
        });

        function loadAllBlogs() {
            fetch('/read-all')
                .then(res => res.json())
                .then(data => renderBlogs(data));
        }

        function renderBlogs(data) {
            const blogList = document.querySelector('.blog-list');
            blogList.innerHTML = '';

            data.forEach(board => {
                const card = document.createElement('div');
                card.className = 'blog-card';

                const titleLink = document.createElement('a');
                titleLink.className = 'blog-title';
                titleLink.href = `/board/${board.id}`;
                titleLink.innerText = board.title || '제목 없음';
                card.appendChild(titleLink);

                (board.locations || []).forEach(loc => {
                    const locationDiv = document.createElement('div');
                    locationDiv.className = 'blog-location';
                    locationDiv.innerText = loc.locationName || '장소명 없음';
                    locationDiv.onclick = () => showMarkerByLocationID(loc.id);

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'blog-content-preview';
                    contentDiv.innerText = loc.content || '내용 없음';

                    card.appendChild(locationDiv);
                    card.appendChild(contentDiv);
                });

                blogList.appendChild(card);
            });
        }

        function renderNearbyBlogsSeparately(locations) {
            const blogList = document.querySelector('.blog-list');
            blogList.innerHTML = '';

            // locations 배열을 그대로 순회하며 각 위치별로 카드 생성
            locations.forEach(loc => {
                const card = document.createElement('div');
                card.className = 'blog-card';

                // 블로그 제목 링크 생성 (loc에 board_name, board_id가 있다고 가정)
                const titleLink = document.createElement('a');
                titleLink.className = 'blog-title';
                titleLink.href = `/board/${loc.board_id}`;
                titleLink.innerText = loc.board_name || '제목 없음';
                card.appendChild(titleLink);

                // 위치명
                const locationDiv = document.createElement('div');
                locationDiv.className = 'blog-location';
                locationDiv.innerText = loc.locationName || '장소명 없음';
                locationDiv.onclick = () => showMarkerByLocationID(loc.id);
                card.appendChild(locationDiv);

                // 내용 미리보기
                const contentDiv = document.createElement('div');
                contentDiv.className = 'blog-content-preview';
                contentDiv.innerText = loc.content || '내용 없음';
                card.appendChild(contentDiv);

                blogList.appendChild(card);
            });
        }

        function showMarkerByLocationID(locationId) {
            if (!locationId) return;

            fetch(`/api/coordinates?id=${encodeURIComponent(locationId)}`)
                .then(res => res.json())
                .then(data => {
                    if (marker) marker.setMap(null);

                    const position = new kakao.maps.LatLng(data.latitude, data.longitude);
                    marker = new kakao.maps.Marker({ position, map });

                    map.setCenter(position);
                    map.setLevel(3);
                })
                .catch(() => alert("위치를 불러오는 데 실패했습니다."));
        }

        loadAllBlogs();
    });
</script>

</body>
</html>
