<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—¬í–‰ í”Œë˜ë„ˆ</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: sans-serif;
            background-color: #f8f8f8;
        }

        body {
            display: flex;
            height: 100vh;
        }

        .left-panel {
            width: 20%;
            display: flex;
            flex-direction: column;
            border-right: 2px solid #000;
            box-sizing: border-box;
            position: relative; /* íŒì—… ìœ„ì¹˜ ì¡°ì •ì„ ìœ„í•¨ */
        }

        .place-list {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .add-button-wrapper {
            border-top: 1px solid #ccc;
            padding: 10px;
        }

        .add-button {
            padding: 10px;
            font-size: 16px;
            background-color: white;
            border: 2px solid black;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
        }

        .map-panel {
            width: 60%;
            height: 100vh;
        }

        .right-panel {
            width: 20%;
            border-left: 2px solid #000;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .right-panel h3 {
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
        }
        .blog-list {
            /* ë¸”ë¡œê·¸ ê¸€ ëª©ë¡ì„ ìœ„í•œ ìŠ¤íƒ€ì¼ */
        }
        .blog-item {
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #fff;
            cursor: pointer;
        }
        .blog-item:hover {
            background-color: #f5f5f5;
        }
        .blog-item h4 {
            margin-top: 0;
            margin-bottom: 5px;
            font-size: 16px;
            color: #333;
        }
        .blog-item p {
            font-size: 13px;
            color: #666;
            margin: 0;
            line-height: 1.4;
            max-height: 60px; /* ë¯¸ë¦¬ë³´ê¸° í…ìŠ¤íŠ¸ ë†’ì´ ì œí•œ */
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .blog-item img {
            max-width: 100%;
            height: auto;
            border-radius: 3px;
            margin-bottom: 5px;
        }


        /* --- place-block ê´€ë ¨ ìŠ¤íƒ€ì¼ --- */
        .place-entry {
            margin-bottom: 15px;
            position: relative; /* ì‚­ì œ ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì •ì„ ìœ„í•¨ */
        }

        .place-block {
            display: flex;
            align-items: flex-start;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
            width: calc(100% - 20px);
            box-sizing: border-box;
            position: relative;
        }

        .pin-icon {
            font-size: 24px;
            margin-right: 10px;
            position: relative;
            top: -2px;
            color: #ff0000; /* ê¸°ë³¸ í•€ ìƒ‰ìƒ */
            cursor: pointer; /* í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ */
            /* ì•„ë˜ ë‘ ì¤„ ì¶”ê°€/ìˆ˜ì •: í´ë¦­ ì˜ì—­ í™•ì¥ */
            width: 24px; /* í•€ ì•„ì´ì½˜ì˜ ë„ˆë¹„ë¥¼ ëª…ì‹œí•˜ì—¬ í´ë¦­ ì˜ì—­ í™•ë³´ */
            height: 24px; /* í•€ ì•„ì´ì½˜ì˜ ë†’ì´ë¥¼ ëª…ì‹œí•˜ì—¬ í´ë¦­ ì˜ì—­ í™•ë³´ */
            display: flex; /* ë‚´ë¶€ ìš”ì†Œ(ìˆ«ì)ë¥¼ ì¤‘ì•™ ì •ë ¬í•˜ê¸° ìœ„í•´ flex ì‚¬ìš© */
            justify-content: center; /* ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ */
            align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
        }

        .pin-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            /* ì•„ë˜ í•œ ì¤„ ì¶”ê°€: ìˆ«ì ì˜¤ë²„ë ˆì´ ìì²´ì˜ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ë¹„í™œì„±í™” */
            pointer-events: none; /* ì´ ìš”ì†Œë¥¼ í´ë¦­í•´ë„ ë’¤ì— ìˆëŠ” .pin-iconì´ í´ë¦­ë˜ë„ë¡ í•¨ */
        }

        .input-group {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            margin-right: 10px;
        }

        .place-input, .time-input {
            width: calc(100% - 6px);
            padding: 5px;
            margin-bottom: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-sizing: border-box;
        }
        .place-input:last-child, .time-input:last-child {
            margin-bottom: 0;
        }

        .drag-handle {
            width: 15px;
            height: 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: grab; /* ë“œë˜ê·¸ ê°€ëŠ¥í•œ ì»¤ì„œ */
            padding: 5px 0;
        }

        .drag-dot {
            width: 4px;
            height: 4px;
            background-color: #888;
            border-radius: 50%;
            margin: 2px 0;
        }

        .travel-time-block {
            margin-top: 10px;
            padding-left: 30px; /* í•€ ì•„ì´ì½˜ ê³µê°„ë§Œí¼ ë“¤ì—¬ì“°ê¸° */
            display: flex;
            align-items: center;
        }
        .travel-time-block label {
            margin-right: 10px;
            font-size: 14px;
            color: #555;
        }
        .travel-time-input {
            width: 80px; /* ì…ë ¥ í•„ë“œ ë„ˆë¹„ ì¡°ì • */
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .travel-mode-select {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            margin-left: 10px;
        }


        #map {
            width: 100%;
            height: 100%;
        }

        /* Sortable.jsì˜ ë“œë˜ê·¸ ì¤‘ì¸ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #f0f0f0;
            border: 1px dashed #aaa;
        }

        /* ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .delete-button {
            position: absolute;
            top: -8px; /* ìœ„ë¡œ ì•½ê°„ ì˜¬ë¦¼ */
            right: -8px; /* ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì•½ê°„ ë¹¼ëƒ„ */
            background-color: #ff4d4d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
            z-index: 10; /* ë‹¤ë¥¸ ìš”ì†Œ ìœ„ë¡œ */
        }
        .delete-button:hover {
            background-color: #cc0000;
        }

        /* í•€ ìƒ‰ìƒ ì„ íƒ íŒì—… ìŠ¤íƒ€ì¼ */
        .color-picker-popup {
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 8px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            z-index: 100; /* ë§¤ìš° ë†’ê²Œ ì„¤ì •í•˜ì—¬ ë‹¤ë¥¸ ìš”ì†Œ ìœ„ì— í‘œì‹œ */
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            /* JavaScriptì—ì„œ top, left ì„¤ì • */
        }
        .color-box {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: transform 0.1s ease-in-out;
        }
        .color-box:hover {
            transform: scale(1.1);
            border-color: #999;
        }

        .pin-icon {
            font-size: 24px;
            margin-right: 10px;
            position: relative;
            top: -2px;
            color: #ff0000; /* ê¸°ë³¸ í•€ ìƒ‰ìƒ */
            cursor: pointer; /* í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ */
            /* ì•„ë˜ ë‘ ì¤„ ì¶”ê°€/ìˆ˜ì •: í´ë¦­ ì˜ì—­ í™•ì¥ */
            width: 24px; /* í•€ ì•„ì´ì½˜ì˜ ë„ˆë¹„ë¥¼ ëª…ì‹œí•˜ì—¬ í´ë¦­ ì˜ì—­ í™•ë³´ */
            height: 24px; /* í•€ ì•„ì´ì½˜ì˜ ë†’ì´ë¥¼ ëª…ì‹œí•˜ì—¬ í´ë¦­ ì˜ì—­ í™•ë³´ */
            display: flex; /* ë‚´ë¶€ ìš”ì†Œ(ìˆ«ì)ë¥¼ ì¤‘ì•™ ì •ë ¬í•˜ê¸° ìœ„í•´ flex ì‚¬ìš© */
            justify-content: center; /* ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ */
            align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
        }

        .pin-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            /* ì•„ë˜ í•œ ì¤„ ì¶”ê°€: ìˆ«ì ì˜¤ë²„ë ˆì´ ìì²´ì˜ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ë¹„í™œì„±í™” */
            pointer-events: none; /* ì´ ìš”ì†Œë¥¼ í´ë¦­í•´ë„ ë’¤ì— ìˆëŠ” .pin-iconì´ í´ë¦­ë˜ë„ë¡ í•¨ */
        }
    </style>
</head>
<body>
<div class="left-panel">
    <div id="place-list" class="place-list"></div>
    <div class="add-button-wrapper">
        <button class="add-button" onclick="openPostcode()">ì¥ì†Œì¶”ê°€ ï¼‹</button>
    </div>
</div>
<div class="map-panel">
    <div id="map"></div>
</div>
<div class="right-panel">
    <h3>ë¸”ë¡œê·¸</h3>
    <div id="blog-list" class="blog-list">
        <p style="text-align: center; color: #888;">ì§€ë„ì˜ í•€ì„ í´ë¦­í•˜ë©´<br>ê´€ë ¨ ë¸”ë¡œê·¸ ê¸€ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
    </div>
</div>

<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=d1f3efee0d30bdde7b35e1ecd17db79f&libraries=services&autoload=false"></script>
<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
    let map;
    // placesData ë°°ì—´ì€ ê° ì¥ì†Œì˜ ëª¨ë“  ì •ë³´ (id, address, lat, lng, placeName, time, marker, overlay, travelTimeToNext, travelModeToNext, pinColor)ë¥¼ ë‹´ìŠµë‹ˆë‹¤.
    let placesData = [];
    const rightPanelBlogList = document.getElementById('blog-list');

    // í•€ ìƒ‰ìƒ ì˜µì…˜ (ìƒ‰ìƒ ì½”ë“œ)
    const pinColorOptions = ['#FF0000', '#0000FF', '#008000', '#800080', '#FFA500', '#40E0D0', '#FFC0CB']; // ë¹¨ê°•, íŒŒë‘, ì´ˆë¡, ë³´ë¼, ì£¼í™©, í„°ì½°ì´ì¦ˆ, í•‘í¬

    // ì¹´ì¹´ì˜¤ ë§µ API ë¡œë”© í›„ initMap í˜¸ì¶œ
    kakao.maps.load(function () {
        initMap();
        initSortable(); // Sortable.js ì´ˆê¸°í™”
        loadPlacesFromLocalStorage(); // í˜ì´ì§€ ë¡œë“œ ì‹œ localStorageì—ì„œ ì¥ì†Œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°

        // **ì´ë²¤íŠ¸ ìœ„ì„ ë°©ì‹ìœ¼ë¡œ í•€ ì•„ì´ì½˜ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì™¼ìª½ íŒ¨ë„ í•€ ìƒ‰ìƒ ë³€ê²½ìš©)**
        const placeListElement = document.getElementById('place-list');
        placeListElement.addEventListener('click', function(event) {
            const pinIcon = event.target.closest('.pin-icon');
            if (pinIcon) {
                // place-entry ìš”ì†Œë¥¼ ì°¾ì•„ì„œ data-idë¥¼ ê°€ì ¸ì˜´
                const placeEntry = pinIcon.closest('.place-entry');
                if (placeEntry) {
                    const placeId = placeEntry.dataset.id;
                    openColorPicker(pinIcon, placeId);
                }
            }
        });
    });

    function initMap() {
        const mapContainer = document.getElementById('map');
        const mapOption = {
            center: new kakao.maps.LatLng(33.450701, 126.570667), // ì œì£¼ë„ ì¤‘ì‹¬ ì¢Œí‘œ
            level: 3 // í™•ëŒ€ ë ˆë²¨
        };
        map = new kakao.maps.Map(mapContainer, mapOption);
    }

    // Sortable.js ì´ˆê¸°í™” í•¨ìˆ˜
    function initSortable() {
        const placeListElement = document.getElementById('place-list');
        Sortable.create(placeListElement, {
            handle: '.drag-handle', // ë“œë˜ê·¸ í•¸ë“¤ í´ë˜ìŠ¤ ì§€ì •
            animation: 150, // ì• ë‹ˆë©”ì´ì…˜ ì†ë„
            onEnd: function (evt) {
                // ë“œë˜ê·¸ê°€ ëë‚¬ì„ ë•Œ í˜¸ì¶œë  í•¨ìˆ˜
                const oldIndex = evt.oldIndex;
                const newIndex = evt.newIndex;

                // placesData ë°°ì—´ì˜ ìˆœì„œë¥¼ ë³€ê²½
                const [movedItem] = placesData.splice(oldIndex, 1);
                placesData.splice(newIndex, 0, movedItem);

                updatePlaceNumbersAndRenderAll(); // ë²ˆí˜¸ ì—…ë°ì´íŠ¸ ë° ì „ì²´ ë Œë”ë§ ê°±ì‹ 
                savePlacesToLocalStorage(); // ìˆœì„œ ë³€ê²½ í›„ localStorageì— ì €ì¥
            }
        });
    }

    // ì¥ì†Œ ì¶”ê°€í•˜ê¸° (ì¹´ì¹´ì˜¤ ìš°í¸ë²ˆí˜¸ ì„œë¹„ìŠ¤ ì‚¬ìš©)
    function openPostcode() {
        new daum.Postcode({
            oncomplete: function(data) {
                const address = data.address;
                addPlace(address);
            }
        }).open();
    }

    // ì¥ì†Œ ì¶”ê°€ ë¡œì§
    function addPlace(address) {
        const geocoder = new kakao.maps.services.Geocoder();
        geocoder.addressSearch(address, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                const coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                const marker = new kakao.maps.Marker({
                    map: map,
                    position: coords
                });

                // ì´ˆê¸° í•€ ìƒ‰ìƒ ì„¤ì •
                const initialPinColor = '#FF0000'; // ê¸°ë³¸ ë¹¨ê°•

                const overlay = new kakao.maps.CustomOverlay({
                    map: map,
                    position: coords,
                    content: createPinOverlayContent(1, initialPinColor), // ì´ˆê¸° í•€ ë²ˆí˜¸ì™€ ìƒ‰ìƒìœ¼ë¡œ ì˜¤ë²„ë ˆì´ ìƒì„±
                    yAnchor: 1.5,
                    xAnchor: 0.5
                });

                // **ì§€ë„ ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ë¸”ë¡œê·¸ ê²€ìƒ‰ìš©)**
                kakao.maps.event.addListener(marker, 'click', function() {
                    // result[0].place_name ì´ ì—†ìœ¼ë©´ result[0].address_name ì„ ì‚¬ìš©
                    displayBlogPosts(result[0].place_name || result[0].address_name);
                });

                // localStorage ì €ì¥ì„ ìœ„í•œ ê³ ìœ  ID ìƒì„±
                const newPlaceId = 'local_id_' + Date.now() + Math.random().toString(36).substr(2, 9);

                const newPlace = {
                    id: newPlaceId,
                    address: address,
                    lat: coords.getLat(), // ìœ„ë„
                    lng: coords.getLng(), // ê²½ë„
                    placeName: result[0].place_name || address, // ì¥ì†Œëª… ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ì£¼ì†Œ
                    time: '', // ì´ˆê¸° ë¨¸ë¬´ëŠ” ì‹œê°„ (ì‚¬ìš©ìê°€ ì…ë ¥)
                    travelTimeToNext: '', // ë‹¤ìŒ ì¥ì†Œê¹Œì§€ì˜ ì´ë™ ì‹œê°„
                    travelModeToNext: 'driving', // ë‹¤ìŒ ì¥ì†Œê¹Œì§€ì˜ ì´ë™ ìˆ˜ë‹¨ (ê¸°ë³¸ê°’)
                    pinColor: initialPinColor, // í•€ ìƒ‰ìƒ ì¶”ê°€
                    marker: marker, // ì§€ë„ ë§ˆì»¤ ê°ì²´
                    overlay: overlay // ì§€ë„ ì˜¤ë²„ë ˆì´ ê°ì²´
                };

                placesData.push(newPlace); // placesData ë°°ì—´ì— ìƒˆë¡œìš´ ì¥ì†Œ ì •ë³´ ì¶”ê°€

                map.setCenter(coords);
                updatePlaceNumbersAndRenderAll(); // ë²ˆí˜¸ ì—…ë°ì´íŠ¸ ë° ì „ì²´ ë Œë”ë§ ê°±ì‹ 
                savePlacesToLocalStorage(); // ë³€ê²½ì‚¬í•­ localStorageì— ì €ì¥

            } else {
                alert('ì£¼ì†Œ ê²€ìƒ‰ ì‹¤íŒ¨: ' + status);
            }
        });
    }

    // ì§€ë„ í•€ ì˜¤ë²„ë ˆì´ HTML ìƒì„± í•¨ìˆ˜
    function createPinOverlayContent(number, color) {
        return `
            <div style="color: white; background: ${color}; border: 1px solid ${color}; border-radius: 50%; width: 24px; height: 24px; display: flex; justify-content: center; align-items: center; font-size: 12px; font-weight: bold;">
                ${number}
            </div>`;
    }

    // ì¥ì†Œ ë¸”ë¡ ë° ì´ë™ ì‹œê°„ ë¸”ë¡ì„ ì™¼ìª½ íŒ¨ë„ì— ì „ì²´ ì¬ë Œë”ë§
    function updatePlaceNumbersAndRenderAll() {
        const container = document.getElementById('place-list');
        container.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ëª¨ë‘ ë¹„ìš°ê¸°

        placesData.forEach((place, index) => {
            const placeEntryDiv = document.createElement('div');
            placeEntryDiv.className = 'place-entry';
            placeEntryDiv.dataset.id = place.id; // HTML ë¸”ë¡ì— ê³ ìœ  ID ì €ì¥

            const placeBlock = document.createElement('div');
            placeBlock.className = 'place-block';
            placeBlock.innerHTML = `
                <div class="pin-icon" style="color: ${place.pinColor};">
                    ğŸ“
                    <span class="pin-number">${index + 1}</span>
                </div>
                <div class="input-group">
                    <input class="place-input" type="text" value="${place.placeName || place.address}" placeholder="ì¥ì†Œ ì´ë¦„" data-id="${place.id}" onchange="updatePlaceData('${place.id}', 'placeName', this.value)" />
                    <input class="time-input" type="text" value="${place.time || ''}" placeholder="ë¨¸ë¬´ëŠ” ì‹œê°„ (ì˜ˆ: 1ì‹œê°„ 30ë¶„)" data-id="${place.id}" onchange="updatePlaceData('${place.id}', 'time', this.value)" />
                </div>
                <div class="drag-handle">
                    <div class="drag-dot"></div>
                    <div class="drag-dot"></div>
                </div>
                <button class="delete-button" onclick="deletePlace('${place.id}')">X</button>
            `;
            placeEntryDiv.appendChild(placeBlock);

            // ë§ˆì§€ë§‰ ì¥ì†Œê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì´ë™ ì‹œê°„ ë¸”ë¡ ì¶”ê°€
            if (index < placesData.length - 1) {
                const travelTimeBlock = document.createElement('div');
                travelTimeBlock.className = 'travel-time-block';
                travelTimeBlock.innerHTML = `
                    <label>ë‹¤ìŒ ì¥ì†Œê¹Œì§€ ì´ë™:</label>
                    <input class="travel-time-input" type="text" value="${place.travelTimeToNext || ''}" placeholder="ì˜ˆ: 30ë¶„" data-id="${place.id}" onchange="updatePlaceData('${place.id}', 'travelTimeToNext', this.value)" />
                    <select class="travel-mode-select" data-id="${place.id}" onchange="updatePlaceData('${place.id}', 'travelModeToNext', this.value)">
                        <option value="driving" ${place.travelModeToNext === 'driving' ? 'selected' : ''}>ìë™ì°¨</option>
                        <option value="transit" ${place.travelModeToNext === 'transit' ? 'selected' : ''}>ëŒ€ì¤‘êµí†µ</option>
                        <option value="walking" ${place.travelModeToNext === 'walking' ? 'selected' : ''}>ë„ë³´</option>
                        <option value="bicycling" ${place.travelModeToNext === 'bicycling' ? 'selected' : ''}>ìì „ê±°</option>
                    </select>
                `;
                placeEntryDiv.appendChild(travelTimeBlock);
            }

            container.appendChild(placeEntryDiv);

            // ì§€ë„ ì˜¤ë²„ë ˆì´(ë¼ë²¨)ì˜ ìˆ«ìì™€ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
            if (place.overlay) {
                place.overlay.setContent(createPinOverlayContent(index + 1, place.pinColor));
            }
        });
    }

    // ì¥ì†Œ ë°ì´í„° ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì¥ì†Œ ì´ë¦„, ë¨¸ë¬´ëŠ” ì‹œê°„, ì´ë™ ì‹œê°„, ì´ë™ ìˆ˜ë‹¨, í•€ ìƒ‰ìƒ ì…ë ¥ ì‹œ placesDataì— ë°˜ì˜)
    function updatePlaceData(id, field, value) {
        const itemIndex = placesData.findIndex(p => p.id === id);
        if (itemIndex > -1) {
            placesData[itemIndex][field] = value;
            savePlacesToLocalStorage(); // ë³€ê²½ì‚¬í•­ localStorageì— ì €ì¥

            // í•€ ìƒ‰ìƒì´ ë³€ê²½ëœ ê²½ìš°, ì§€ë„ ì˜¤ë²„ë ˆì´ë„ ì—…ë°ì´íŠ¸
            if (field === 'pinColor' && placesData[itemIndex].overlay) {
                const currentPlaceIndex = placesData.indexOf(placesData[itemIndex]);
                placesData[itemIndex].overlay.setContent(createPinOverlayContent(currentPlaceIndex + 1, value));
            }
        }
    }

    // --- ì¥ì†Œ ì‚­ì œ í•¨ìˆ˜ ---
    function deletePlace(idToDelete) {
        const itemIndex = placesData.findIndex(p => p.id === idToDelete);

        if (itemIndex > -1) {
            const placeToRemove = placesData[itemIndex];

            // 1. ì§€ë„ì—ì„œ ë§ˆì»¤ì™€ ì˜¤ë²„ë ˆì´ ì œê±°
            if (placeToRemove.marker) {
                placeToRemove.marker.setMap(null);
            }
            if (placeToRemove.overlay) {
                placeToRemove.overlay.setMap(null);
            }

            // 2. placesData ë°°ì—´ì—ì„œ ì¥ì†Œ ì œê±°
            placesData.splice(itemIndex, 1);

            // 3. UI ë° LocalStorage ì—…ë°ì´íŠ¸
            updatePlaceNumbersAndRenderAll(); // ì „ì²´ ì¬ë Œë”ë§í•˜ì—¬ ë²ˆí˜¸ ë° ì´ë™ ì‹œê°„ ë¸”ë¡ ê°±ì‹ 
            savePlacesToLocalStorage(); // localStorageì— ì €ì¥
            console.log(`ì¥ì†Œ (ID: ${idToDelete})ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);

            // ì‚­ì œ í›„ ë¸”ë¡œê·¸ ëª©ë¡ ì´ˆê¸°í™”
            rightPanelBlogList.innerHTML = '<p style="text-align: center; color: #888;">ì§€ë„ì˜ í•€ì„ í´ë¦­í•˜ë©´<br>ê´€ë ¨ ë¸”ë¡œê·¸ ê¸€ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>';
        }
    }


    // --- localStorage ê´€ë ¨ í•¨ìˆ˜ ---

    // localStorageì— ì¥ì†Œ ë°ì´í„° ì €ì¥
    function savePlacesToLocalStorage() {
        // ë§ˆì»¤, ì˜¤ë²„ë ˆì´ ê°ì²´ëŠ” ì§ë ¬í™”í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ë°ì´í„°ë§Œ ì¶”ì¶œí•˜ì—¬ ì €ì¥
        const dataToSave = placesData.map(p => ({
            id: p.id,
            address: p.address,
            lat: p.marker.getPosition().getLat(), // ìœ„ë„ ê²½ë„ ë‹¤ì‹œ ì €ì¥
            lng: p.marker.getPosition().getLng(),
            placeName: p.placeName,
            time: p.time,
            travelTimeToNext: p.travelTimeToNext,
            travelModeToNext: p.travelModeToNext,
            pinColor: p.pinColor // í•€ ìƒ‰ìƒ ì €ì¥
        }));
        localStorage.setItem('travelPlannerPlaces', JSON.stringify(dataToSave));
        console.log("ì¥ì†Œ ë°ì´í„°ê°€ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    // localStorageì—ì„œ ì¥ì†Œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    function loadPlacesFromLocalStorage() {
        const savedData = localStorage.getItem('travelPlannerPlaces');
        if (savedData) {
            const parsedData = JSON.parse(savedData);

            // ê¸°ì¡´ ë§ˆì»¤ì™€ ì˜¤ë²„ë ˆì´ ëª¨ë‘ ì œê±°
            placesData.forEach(p => {
                if(p.marker) p.marker.setMap(null);
                if(p.overlay) p.overlay.setMap(null);
            });

            placesData = []; // placesData ì´ˆê¸°í™”

            parsedData.forEach(place => {
                const coords = new kakao.maps.LatLng(place.lat, place.lng);

                const marker = new kakao.maps.Marker({
                    map: map,
                    position: coords
                });

                // ë¶ˆëŸ¬ì˜¬ ë•Œ í•€ ìƒ‰ìƒë„ í•¨ê»˜ ì„¤ì •
                const loadedPinColor = place.pinColor || '#FF0000'; // ì €ì¥ëœ ìƒ‰ìƒì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ë¹¨ê°•

                const overlay = new kakao.maps.CustomOverlay({
                    map: map,
                    position: coords,
                    content: createPinOverlayContent(0, loadedPinColor), // ì´ˆê¸° ë²ˆí˜¸ëŠ” 0ìœ¼ë¡œ ì„¤ì •, updatePlaceNumbersAndRenderAllì—ì„œ ì—…ë°ì´íŠ¸ë¨
                    yAnchor: 1.5,
                    xAnchor: 0.5
                });

                // **ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ë¡œë“œ ì‹œì—ë„ ì¬ì„¤ì •)**
                kakao.maps.event.addListener(marker, 'click', function() {
                    displayBlogPosts(place.placeName || place.address);
                });


                // ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ë¥¼ placesData ë°°ì—´ì— ë‹¤ì‹œ ì±„ì›Œë„£ìŒ
                placesData.push({
                    id: place.id,
                    marker: marker,
                    overlay: overlay,
                    address: place.address,
                    lat: place.lat,
                    lng: place.lng,
                    placeName: place.placeName,
                    time: place.time,
                    travelTimeToNext: place.travelTimeToNext || '',
                    travelModeToNext: place.travelModeToNext || 'driving',
                    pinColor: loadedPinColor // í•€ ìƒ‰ìƒ ì¶”ê°€
                });
            });
            updatePlaceNumbersAndRenderAll(); // ë²ˆí˜¸ ì—…ë°ì´íŠ¸ ë° ì „ì²´ ë Œë”ë§ (DOM ê°±ì‹ )
            if (placesData.length > 0) {
                map.setCenter(placesData[0].marker.getPosition()); // ì²« ì¥ì†Œë¡œ ì§€ë„ ì´ë™
            }
            console.log('ì´ì „ ì¥ì†Œ ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', placesData);
        } else {
            console.log('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ëœ ì¥ì†Œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    // --- í•€ ìƒ‰ìƒ ì„ íƒ íŒì—… ê´€ë ¨ í•¨ìˆ˜ ---
    let currentColorPickerPopup = null; // í˜„ì¬ ì—´ë ¤ìˆëŠ” ìƒ‰ìƒ ì„ íƒ íŒì—…ì„ ì¶”ì 

    function openColorPicker(pinIconElement, placeId) {
        // ê¸°ì¡´ íŒì—…ì´ ìˆë‹¤ë©´ ë‹«ê¸°
        if (currentColorPickerPopup) {
            currentColorPickerPopup.remove();
            currentColorPickerPopup = null;
        }

        const popup = document.createElement('div');
        popup.className = 'color-picker-popup';
        popup.dataset.placeId = placeId; // ì–´ë–¤ ì¥ì†Œì˜ í•€ì¸ì§€ ì•Œ ìˆ˜ ìˆë„ë¡ placeId ì €ì¥

        pinColorOptions.forEach(color => {
            const colorBox = document.createElement('div');
            colorBox.className = 'color-box';
            colorBox.style.backgroundColor = color;
            colorBox.dataset.color = color; // ì„ íƒëœ ìƒ‰ìƒ ì €ì¥
            colorBox.onclick = (event) => {
                event.stopPropagation(); // íŒì—… ë‹«í˜ ë°©ì§€
                selectPinColor(placeId, color);
                popup.remove(); // ìƒ‰ìƒ ì„ íƒ í›„ íŒì—… ë‹«ê¸°
                currentColorPickerPopup = null;
            };
            popup.appendChild(colorBox);
        });

        // íŒì—… ìœ„ì¹˜ ì„¤ì • (í•€ ì•„ì´ì½˜ ì˜†ì—)
        const rect = pinIconElement.getBoundingClientRect();
        const leftPanelRect = document.querySelector('.left-panel').getBoundingClientRect(); // ì™¼ìª½ íŒ¨ë„ì˜ ìœ„ì¹˜ë¥¼ ì–»ìŒ

        // íŒì—…ì˜ ìœ„ì¹˜ë¥¼ ì™¼ìª½ íŒ¨ë„ì„ ê¸°ì¤€ìœ¼ë¡œ ìƒëŒ€ì ìœ¼ë¡œ ê³„ì‚°
        popup.style.top = `${rect.top - leftPanelRect.top + pinIconElement.offsetHeight / 2}px`; // í•€ ì•„ì´ì½˜ ì¤‘ì•™ì— ë§ì¶¤
        popup.style.left = `${rect.right - leftPanelRect.left + 10}px`; // í•€ ì•„ì´ì½˜ ì˜¤ë¥¸ìª½ 10px ìœ„ì¹˜

        // ì™¼ìª½ íŒ¨ë„ ë‚´ë¶€ì— íŒì—… ì¶”ê°€
        document.querySelector('.left-panel').appendChild(popup);
        currentColorPickerPopup = popup;

        // íŒì—… ì™¸ë¶€ë¥¼ í´ë¦­í•˜ë©´ íŒì—… ë‹«ê¸°
        document.addEventListener('click', closeColorPickerOnClickOutside, true); // ìº¡ì²˜ë§ ë‹¨ê³„ì—ì„œ ì´ë²¤íŠ¸ë¥¼ ì¡ë„ë¡ true ì„¤ì •
    }

    function closeColorPickerOnClickOutside(event) {
        if (currentColorPickerPopup && !currentColorPickerPopup.contains(event.target)) {
            currentColorPickerPopup.remove();
            currentColorPickerPopup = null;
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
            document.removeEventListener('click', closeColorPickerOnClickOutside, true);
        }
    }

    function selectPinColor(placeId, color) {
        const place = placesData.find(p => p.id === placeId);
        if (place) {
            // 1. placesData ì—…ë°ì´íŠ¸
            place.pinColor = color;

            // 2. ì™¼ìª½ íŒ¨ë„ í•€ ì•„ì´ì½˜ ìƒ‰ìƒ ì—…ë°ì´íŠ¸ (DOM ì§ì ‘ ì¡°ì‘)
            const placeBlockElement = document.querySelector(`.place-entry[data-id="${placeId}"] .pin-icon`);
            if (placeBlockElement) {
                placeBlockElement.style.color = color;
            }

            // 3. ì§€ë„ ì˜¤ë²„ë ˆì´ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
            if (place.overlay) {
                const currentPlaceIndex = placesData.indexOf(place);
                place.overlay.setContent(createPinOverlayContent(currentPlaceIndex + 1, color));
            }

            // 4. LocalStorageì— ì €ì¥
            savePlacesToLocalStorage();
            console.log(`ì¥ì†Œ (ID: ${placeId})ì˜ í•€ ìƒ‰ìƒì´ ${color}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }
    }


    // --- ë¸”ë¡œê·¸ ê¸°ëŠ¥ (ì˜¤ë¥¸ìª½ ì¹¸) ---
    async function displayBlogPosts(query) {
        console.log(`Searching blogs for: ${query}`);
        rightPanelBlogList.innerHTML = '<p style="text-align: center; color: #888;">ë¸”ë¡œê·¸ ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

        try {
            const naverClientId = 'dn_mPBS_Cji2mipu5qOV';
            const naverClientSecret = 'Uw1mfm_PGW';

            if (!naverClientId || !naverClientSecret) {
                throw new Error("ë„¤ì´ë²„ Client ID ë˜ëŠ” Client Secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê°œë°œì ì„¼í„°ì—ì„œ ë°œê¸‰ë°›ì•„ ì½”ë“œë¥¼ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”.");
            }

            const response = await fetch(`https://cors-anywhere.herokuapp.com/https://openapi.naver.com/v1/search/blog?query=${encodeURIComponent(query)}&display=5`, {
                method: 'GET',
                headers: {
                    'X-Naver-Client-Id': naverClientId,
                    'X-Naver-Client-Secret': naverClientSecret
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error("Naver API Error Response:", errorText);
                throw new Error(`ë¸”ë¡œê·¸ API ìš”ì²­ ì‹¤íŒ¨! ìƒíƒœ: ${response.status}, ë©”ì‹œì§€: ${errorText}`);
            }

            const data = await response.json();
            console.log("Naver Blog API Response:", data);

            rightPanelBlogList.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì§€ìš°ê¸°

            if (data.items && data.items.length > 0) {
                data.items.forEach(item => {
                    const blogItem = document.createElement('div');
                    blogItem.className = 'blog-item';
                    blogItem.onclick = () => window.open(item.link, '_blank'); // ìƒˆ íƒ­ìœ¼ë¡œ ì—´ê¸°

                    // HTML ì—”í‹°í‹° ë””ì½”ë”© ë° <b> íƒœê·¸ ì œê±°
                    const title = item.title.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&').replace(/&quot;/g, '"').replace(/&#039;/g, "'").replace(/<b>/g, '').replace(/<\/b>/g, '');
                    const description = item.description.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&').replace(/&quot;/g, '"').replace(/&#039;/g, "'").replace(/<b>/g, '').replace(/<\/b>/g, '');

                    blogItem.innerHTML = `
                        <h4>${title}</h4>
                        <p>${description}</p>
                    `;
                    rightPanelBlogList.appendChild(blogItem);
                });
            } else {
                rightPanelBlogList.innerHTML = '<p style="text-align: center; color: #888;">ê´€ë ¨ ë¸”ë¡œê·¸ ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

        } catch (error) {
            console.error('Error fetching blog posts:', error);
            rightPanelBlogList.innerHTML = `<p style="text-align: center; color: #ff0000;">ë¸”ë¡œê·¸ ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>ì˜¤ë¥˜: ${error.message}<br>ë„¤ì´ë²„ API í‚¤ ì„¤ì • ë°<br>CORS ë¬¸ì œ í•´ê²° (ë°±ì—”ë“œ í”„ë¡ì‹œ)ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>`;
        }
    }
</script>
</body>
</html>